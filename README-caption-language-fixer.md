# Caption Language Fixer üîß

A powerful tool to automatically fix language mismatches found in video captions after running the caption language validator.

## What It Does

The Caption Language Fixer reads the validation report generated by `captionLanguageValidator.js` and provides multiple options to fix language mismatches:

- **Delete** incorrectly labeled captions
- **Move** captions to their correct language slots
- **Interactive** mode for manual review of each mismatch
- **Batch** mode for automated processing

## Prerequisites

1. You must have already run `captionLanguageValidator.js` to generate a validation report
2. Valid API.video credentials configured in your `.env` file
3. OpenRouter API key (inherited from the validation report)

## Installation

No additional installation required - uses the same dependencies as the validator.

## Usage

### 1. Preview Mode (Default)

See all mismatches without making any changes:

```bash
node captionLanguageFixer.js
```

This will show you:
- Total number of mismatches
- Breakdown by language pattern (e.g., "en ‚Üí it: 15 captions")
- Details for each mismatch

### 2. Interactive Mode

Process each mismatch individually with manual decisions:

```bash
node captionLanguageFixer.js --interactive
```

For each mismatch, you'll see:
- Video title and ID
- Current language slot vs detected language
- Sample text from the caption
- Options to Delete, Move, Skip, or Quit

### 3. Batch Delete Mode

Automatically delete all incorrectly labeled captions:

```bash
node captionLanguageFixer.js --batch-delete
```

‚ö†Ô∏è **Warning**: This permanently removes the mismatched captions!

### 4. Batch Move Mode

Automatically move captions to their correct language slots:

```bash
node captionLanguageFixer.js --batch-move
```

This will:
1. Download the VTT content from the incorrect slot
2. Upload it to the correct language slot (if available)
3. Delete the original incorrect caption

## Example Output

```
üîß Starting Caption Language Fixer...
üîë Ensuring valid authentication...
üìñ Loading validation report: ./caption_validation_report.json

üìä Found 527 language mismatches to fix

üîç Mismatch Summary:
  en ‚Üí it: 45 captions
  en ‚Üí es: 32 captions
  fr ‚Üí en: 28 captions
  ar ‚Üí en: 15 captions

üìã Preview Mode: Showing mismatches (use --batch-delete or --batch-move to fix)

1. Emotional Mastery-1.mp4
   üìç en slot contains italian content
   üìñ "X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000 Ciao e benvenuti a"
   üîó https://vod.api.video/vod/vimRsLwx8pzlV2T5xrZT4Ka/captions/en.vtt

üí° To fix these mismatches:
   node captionLanguageFixer.js --batch-delete  (remove incorrect captions)
   node captionLanguageFixer.js --batch-move    (move to correct language slots)
   node captionLanguageFixer.js --interactive   (process one by one)
```

## Interactive Mode Example

```
üîß Fix Options for: Emotional Mastery-1.mp4 (vimRsLwx8pzlV2T5xrZT4Ka)
üìç Language slot: en (declared as English)
ü§ñ Detected language: italian (it)
üìñ Sample text: "X-TIMESTAMP-MAP=LOCAL:00:00:00.000,MPEGTS:900000 Ciao e benvenuti a"

Options:
  [d] Delete the incorrectly labeled en caption
  [m] Move caption to correct language slot (it)
  [s] Skip this mismatch (keep as is)
  [q] Quit fixer

Choose action (d/m/s/q): m
üîÑ Moving caption from en to it for video vimRsLwx8pzlV2T5xrZT4Ka...
‚úÖ Successfully moved caption from en to it
üóëÔ∏è  Deleting en caption for video vimRsLwx8pzlV2T5xrZT4Ka...
‚úÖ Successfully deleted en caption
```

## Configuration

Set these environment variables in your `.env` file:

```env
# Required (inherited from validator)
API_VIDEO_KEY=your_api_key
OPENROUTER_API_KEY=your_openrouter_key

# Optional fixer settings
DELAY_BETWEEN_REQUESTS=1000          # Delay between API requests (ms)
CAPTION_REPORT_FILE=./caption_validation_report.json  # Input report file
FIXER_OUTPUT_FILE=./caption_fixer_report.json        # Output report file
```

## Output Report

The fixer generates a detailed report in JSON format with:

- **Summary**: Processing statistics and mode used
- **Results**: Detailed results for each processed mismatch

Example report structure:
```json
{
  "summary": {
    "processedAt": "2024-01-15T10:30:00.000Z",
    "action": "delete",
    "totalMismatches": 527,
    "processed": 527,
    "successful": 520,
    "errors": 7
  },
  "results": [
    {
      "mismatch": { /* original mismatch data */ },
      "action": "delete",
      "result": { "success": true },
      "processedAt": "2024-01-15T10:30:01.000Z"
    }
  ]
}
```

## Best Practices

### 1. **Start with Preview Mode**
Always run in preview mode first to understand the scope of mismatches.

### 2. **Use Interactive Mode for Complex Cases**
For videos with valuable content, use interactive mode to make informed decisions.

### 3. **Backup Important Captions**
Consider downloading caption files before batch operations if they contain valuable manual corrections.

### 4. **Move vs Delete Strategy**
- **Move**: When you want to preserve the caption content in the correct language slot
- **Delete**: When the caption is completely wrong or you plan to regenerate captions

### 5. **Monitor API Rate Limits**
The tool includes built-in delays, but monitor your API usage during large batch operations.

## Common Scenarios

### Scenario 1: Auto-generated captions in wrong slots
**Problem**: English captions were auto-generated but saved in Italian slots
**Solution**: `--batch-move` to relocate them properly

### Scenario 2: Completely wrong language detection
**Problem**: Captions are in unexpected languages
**Solution**: `--batch-delete` to remove and regenerate

### Scenario 3: Mixed quality captions
**Problem**: Some captions are good, others are wrong
**Solution**: `--interactive` to review each case

## Troubleshooting

### "Validation report not found"
- Ensure you've run `captionLanguageValidator.js` first
- Check the `CAPTION_REPORT_FILE` path in your `.env`

### "Target language slot already exists"
- The move operation won't overwrite existing captions
- Use delete mode first, then regenerate if needed

### Rate limiting errors
- Increase `DELAY_BETWEEN_REQUESTS` in your `.env`
- Process smaller batches by limiting the validator's scope

### Authentication errors
- Ensure your `API_VIDEO_KEY` is valid and has caption management permissions
- Check that your tokens haven't expired

## Integration Workflow

1. **Generate VTT files** ‚Üí `vttGenerator.js`
2. **Upload with validation** ‚Üí `languageValidatedCaptionUploader.js` 
3. **Validate languages** ‚Üí `captionLanguageValidator.js`
4. **Fix mismatches** ‚Üí `captionLanguageFixer.js` üëà **You are here**
5. **Re-validate** ‚Üí Run validator again to confirm fixes

## API Operations Used

- `GET /videos/{videoId}/captions/{language}` - Check existing captions
- `DELETE /videos/{videoId}/captions/{language}` - Remove incorrect captions  
- `POST /videos/{videoId}/captions/{language}` - Upload captions to correct slots
- HTTP requests to download VTT content for moving operations

## Safety Features

- **Confirmation prompts** for destructive batch operations
- **Detailed logging** of all operations
- **Comprehensive error handling** with rollback information
- **Preview mode** to see changes before applying them
- **Rate limiting** to avoid API quota exhaustion

This tool is designed to be the final step in ensuring your video captions are correctly labeled and properly organized across all supported languages. 