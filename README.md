# API.video Downloader & VTT Generator

A Node.js application to download videos from API.video and generate VTT subtitle files with advanced audio analysis. Now includes automatic caption reuploading capability!

## Features

### Video Downloader
- 🔐 **Secure Authentication** via environment variables
- 📹 **Bulk Download** - Downloads all videos from your API.video account
- ⚡ **Smart Resume** - Skips already downloaded files
- 📊 **Progress Tracking** - Shows download progress and summary
- 🎯 **Configurable Output** - Set custom download folders
- 🆔 **Video ID Integration** - Embeds video IDs in filenames for easy caption reuploading

### VTT Generator
- 🎤 **AI Transcription** using local Whisper or OpenAI Whisper API
- 🔇 **Silence Detection** - Identifies and marks silent moments
- 🎵 **Music Detection** - Special handling for musical segments
- ⏱️ **Precise Timestamps** - WebVTT format with millisecond accuracy
- 🎛️ **Configurable Settings** - Adjustable silence thresholds and detection
- 🆔 **Video ID Tracking** - Maintains video ID association for caption uploads

### Caption Uploader (NEW!)
- 📤 **Automatic Upload** - Uploads VTT files back to API.video
- 🔍 **Smart Matching** - Uses embedded video IDs for accurate association
- 🌐 **Language Support** - Configurable caption language
- 📊 **Batch Processing** - Upload captions for all processed videos
- ✅ **Error Handling** - Detailed reporting of upload success/failures

## Setup

### 1. Install Dependencies
```bash
npm install
```

### 2. Configure Environment
Copy your API key and settings to `.env`:
```bash
# API.video Configuration
API_VIDEO_KEY=your_api_video_key_here

# Folders
OUTPUT_FOLDER=./downloads
VTT_OUTPUT_FOLDER=./subtitles

# OpenAI API Key (optional - local Whisper will be used if not provided)
OPENAI_API_KEY=your_openai_api_key_here

# VTT Generation Settings
WHISPER_MODEL=base
SILENCE_THRESHOLD=0.01
MUSIC_DETECTION_ENABLED=true

# Caption Upload Settings
CAPTION_LANGUAGE=en
```

### 3. Get API Keys
- **API.video Key**: From your API.video dashboard
- **OpenAI Key**: From [OpenAI Platform](https://platform.openai.com/api-keys) (optional for VTT transcription)

## Usage

### Complete Workflow (Download → Generate → Upload)
```bash
# 1. Download all videos with video IDs
node videoDownloader.js

# 2. Generate VTT subtitle files
node vttGenerator.js

# 3. Upload captions back to API.video
node captionUploader.js
```

### Individual Steps

#### Download Videos
```bash
node videoDownloader.js
```
This will:
- Authenticate with API.video
- Fetch all videos (handles pagination automatically)
- Download MP4 files with embedded video IDs: `[videoId]_title.mp4`
- Show progress and summary

#### Generate VTT Subtitles
```bash
node vttGenerator.js
```
This will:
- Process all downloaded video files
- Extract audio and analyze for silence/music
- Generate transcriptions using local Whisper or OpenAI
- Create WebVTT files with video ID metadata: `[videoId]_title.vtt`

#### Upload Captions
```bash
# Upload all VTT files with video IDs
node captionUploader.js

# Upload specific caption file
node captionUploader.js <videoId> <vttFilePath> [language]
```

#### Test Authentication
```bash
node auth.js
```

## File Naming Convention

### New Format (with Video IDs)
- **Videos**: `[vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4`
- **VTT Files**: `[vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.vtt`

### Benefits
- ✅ **Easy Matching**: Video and VTT files are automatically paired
- ✅ **Caption Upload**: Direct reuploading to correct videos
- ✅ **Backup Safety**: Never lose track of which caption belongs to which video
- ✅ **Workflow Automation**: Complete end-to-end processing

## Advanced Features

### Music & Silence Detection
The VTT generator includes intelligent audio analysis:

- **Silence Detection**: Identifies quiet segments using configurable thresholds
- **Music Identification**: Heuristic detection of musical content
- **Special Markers**: Adds `♪ text ♪` for music and `[Silence]` for quiet parts
- **Warnings**: Marks potentially musical segments as `[Possible Music]`

### VTT Metadata
Generated VTT files include metadata:
```vtt
WEBVTT
NOTE Video ID: vimRsLwx8pzlV2T5xrZT4Ka
NOTE Title: Emotional_Mastery-1
NOTE Generated by API.video Downloader & VTT Generator
NOTE Music Detection: Enabled
NOTE Silence Threshold: 0.01

1
00:00:00.000 --> 00:00:05.000
Welcome to this video tutorial
```

### Configuration Options

| Setting | Description | Default |
|---------|-------------|---------|
| `SILENCE_THRESHOLD` | Audio level threshold for silence detection | `0.01` |
| `MUSIC_DETECTION_ENABLED` | Enable/disable music detection heuristics | `true` |
| `WHISPER_MODEL` | Whisper model to use (local) | `base` |
| `OUTPUT_FOLDER` | Where to save downloaded videos | `./downloads` |
| `VTT_OUTPUT_FOLDER` | Where to save VTT subtitle files | `./subtitles` |
| `CAPTION_LANGUAGE` | Default language for caption uploads | `en` |

### File Structure
```
APIVODDownloader/
├── auth.js              # Authentication utilities
├── videoDownloader.js   # Main video download script
├── vttGenerator.js      # VTT subtitle generation
├── captionUploader.js   # Caption upload to API.video (NEW!)
├── .env                 # Your configuration (not in git)
├── .env.example         # Example configuration
├── downloads/           # Downloaded video files (not in git)
│   ├── [videoId1]_title1.mp4
│   └── [videoId2]_title2.mp4
├── subtitles/           # Generated VTT files (not in git)
│   ├── [videoId1]_title1.vtt
│   └── [videoId2]_title2.vtt
└── README.md
```

## Example Workflow

### 1. Download Phase
```bash
$ node videoDownloader.js
🔑 Getting access token...
✅ Authentication successful!

📹 Fetching all videos...
📊 Total videos found: 474

⬇️  Downloading 1/474: Emotional Mastery-1.mp4
🆔 Video ID: vimRsLwx8pzlV2T5xrZT4Ka
📁 Filename: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4
✅ Downloaded: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4
```

### 2. VTT Generation Phase
```bash
$ node vttGenerator.js
🎬 Processing: Emotional_Mastery-1
🆔 Video ID: vimRsLwx8pzlV2T5xrZT4Ka
🎵 Extracting audio...
🔍 Analyzing audio for silence and music detection...
🎤 Using local Whisper for transcription...
📝 Generating VTT content...
✅ VTT generated: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.vtt
💡 Ready for caption upload to video ID: vimRsLwx8pzlV2T5xrZT4Ka
```

### 3. Caption Upload Phase
```bash
$ node captionUploader.js
📊 Caption Upload Overview:
🎬 Total VTT files: 474
🆔 Files with video IDs: 474
📤 Uploading caption for video vimRsLwx8pzlV2T5xrZT4Ka...
✅ Caption uploaded successfully for video vimRsLwx8pzlV2T5xrZT4Ka
📊 Caption Upload Summary:
✅ Successful uploads: 474
```

## Requirements

- **Node.js** 14+ 
- **FFmpeg** (for audio processing)
- **Local Whisper** (recommended) or **OpenAI API Key** (for transcription)
- **API.video Account** with API key

### Ubuntu Server Installation
See [UBUNTU_SETUP.md](UBUNTU_SETUP.md) for complete Ubuntu server setup instructions.

## Cost Considerations

- **API.video**: Check your plan's download/upload limits
- **Local Whisper**: Free transcription (recommended)
- **OpenAI Whisper**: ~$0.006 per minute of audio transcribed (optional)
- **Storage**: Videos and audio files can be large

## Troubleshooting

### Common Issues

1. **FFmpeg not found**: Install FFmpeg and ensure it's in your PATH
2. **Whisper not found**: Install with `pip install openai-whisper`
3. **Caption upload fails**: Check video ID format and API.video permissions
4. **Missing video IDs**: Re-download videos to get proper filename format

### File Migration
If you have old format files (without video IDs), the downloader will automatically rename them when it encounters matching videos.

## License

ISC

## Support

For issues with:
- **API.video API**: Check [API.video documentation](https://docs.api.video/)
- **Local Whisper**: Check [OpenAI Whisper documentation](https://github.com/openai/whisper)
- **This tool**: Open an issue in this repository 