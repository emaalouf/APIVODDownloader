# API.video Downloader & VTT Generator

A Node.js application to download videos from API.video and generate VTT subtitle files with advanced audio analysis. Now includes automatic caption reuploading capability!

## Features

### Video Downloader
- ğŸ” **Secure Authentication** via environment variables
- ğŸ“¹ **Bulk Download** - Downloads all videos from your API.video account
- âš¡ **Smart Resume** - Skips already downloaded files
- ğŸ“Š **Progress Tracking** - Shows download progress and summary
- ğŸ¯ **Configurable Output** - Set custom download folders
- ğŸ†” **Video ID Integration** - Embeds video IDs in filenames for easy caption reuploading

### VTT Generator
- ğŸ¤ **AI Transcription** using local Whisper or OpenAI Whisper API
- ğŸ”‡ **Silence Detection** - Identifies and marks silent moments
- ğŸµ **Music Detection** - Special handling for musical segments
- â±ï¸ **Precise Timestamps** - WebVTT format with millisecond accuracy
- ğŸ›ï¸ **Configurable Settings** - Adjustable silence thresholds and detection
- ğŸ†” **Video ID Tracking** - Maintains video ID association for caption uploads

### Caption Uploader (NEW!)
- ğŸ“¤ **Automatic Upload** - Uploads VTT files back to API.video
- ğŸ” **Smart Matching** - Uses embedded video IDs for accurate association
- ğŸŒ **Language Support** - Configurable caption language
- ğŸ“Š **Batch Processing** - Upload captions for all processed videos
- âœ… **Error Handling** - Detailed reporting of upload success/failures

## Setup

### 1. Install Dependencies
```bash
npm install
```

### 2. Configure Environment
Copy your API key and settings to `.env`:
```bash
# API.video Configuration
API_VIDEO_KEY=your_api_video_key_here

# Folders
OUTPUT_FOLDER=./downloads
VTT_OUTPUT_FOLDER=./subtitles

# OpenAI API Key (optional - local Whisper will be used if not provided)
OPENAI_API_KEY=your_openai_api_key_here

# VTT Generation Settings
WHISPER_MODEL=base
SILENCE_THRESHOLD=0.01
MUSIC_DETECTION_ENABLED=true

# Caption Upload Settings
CAPTION_LANGUAGE=en
```

### 3. Get API Keys
- **API.video Key**: From your API.video dashboard
- **OpenAI Key**: From [OpenAI Platform](https://platform.openai.com/api-keys) (optional for VTT transcription)

## Usage

### Complete Workflow (Download â†’ Generate â†’ Upload)
```bash
# 1. Download all videos with video IDs
node videoDownloader.js

# 2. Generate VTT subtitle files
node vttGenerator.js

# 3. Upload captions back to API.video
node captionUploader.js
```

### Individual Steps

#### Download Videos
```bash
node videoDownloader.js
```
This will:
- Authenticate with API.video
- Fetch all videos (handles pagination automatically)
- Download MP4 files with embedded video IDs: `[videoId]_title.mp4`
- Show progress and summary

#### Generate VTT Subtitles
```bash
node vttGenerator.js
```
This will:
- Process all downloaded video files
- Extract audio and analyze for silence/music
- Generate transcriptions using local Whisper or OpenAI
- Create WebVTT files with video ID metadata: `[videoId]_title.vtt`

#### Upload Captions
```bash
# Upload all VTT files with video IDs
node captionUploader.js

# Upload specific caption file
node captionUploader.js <videoId> <vttFilePath> [language]
```

#### Test Authentication
```bash
node auth.js
```

## File Naming Convention

### New Format (with Video IDs)
- **Videos**: `[vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4`
- **VTT Files**: `[vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.vtt`

### Benefits
- âœ… **Easy Matching**: Video and VTT files are automatically paired
- âœ… **Caption Upload**: Direct reuploading to correct videos
- âœ… **Backup Safety**: Never lose track of which caption belongs to which video
- âœ… **Workflow Automation**: Complete end-to-end processing

## Advanced Features

### Music & Silence Detection
The VTT generator includes intelligent audio analysis:

- **Silence Detection**: Identifies quiet segments using configurable thresholds
- **Music Identification**: Heuristic detection of musical content
- **Special Markers**: Adds `â™ª text â™ª` for music and `[Silence]` for quiet parts
- **Warnings**: Marks potentially musical segments as `[Possible Music]`

### VTT Metadata
Generated VTT files include metadata:
```vtt
WEBVTT
NOTE Video ID: vimRsLwx8pzlV2T5xrZT4Ka
NOTE Title: Emotional_Mastery-1
NOTE Generated by API.video Downloader & VTT Generator
NOTE Music Detection: Enabled
NOTE Silence Threshold: 0.01

1
00:00:00.000 --> 00:00:05.000
Welcome to this video tutorial
```

### Configuration Options

| Setting | Description | Default |
|---------|-------------|---------|
| `SILENCE_THRESHOLD` | Audio level threshold for silence detection | `0.01` |
| `MUSIC_DETECTION_ENABLED` | Enable/disable music detection heuristics | `true` |
| `WHISPER_MODEL` | Whisper model to use (local) | `base` |
| `OUTPUT_FOLDER` | Where to save downloaded videos | `./downloads` |
| `VTT_OUTPUT_FOLDER` | Where to save VTT subtitle files | `./subtitles` |
| `CAPTION_LANGUAGE` | Default language for caption uploads | `en` |

### File Structure
```
APIVODDownloader/
â”œâ”€â”€ auth.js              # Authentication utilities
â”œâ”€â”€ videoDownloader.js   # Main video download script
â”œâ”€â”€ vttGenerator.js      # VTT subtitle generation
â”œâ”€â”€ captionUploader.js   # Caption upload to API.video (NEW!)
â”œâ”€â”€ .env                 # Your configuration (not in git)
â”œâ”€â”€ .env.example         # Example configuration
â”œâ”€â”€ downloads/           # Downloaded video files (not in git)
â”‚   â”œâ”€â”€ [videoId1]_title1.mp4
â”‚   â””â”€â”€ [videoId2]_title2.mp4
â”œâ”€â”€ subtitles/           # Generated VTT files (not in git)
â”‚   â”œâ”€â”€ [videoId1]_title1.vtt
â”‚   â””â”€â”€ [videoId2]_title2.vtt
â””â”€â”€ README.md
```

## Example Workflow

### 1. Download Phase
```bash
$ node videoDownloader.js
ğŸ”‘ Getting access token...
âœ… Authentication successful!

ğŸ“¹ Fetching all videos...
ğŸ“Š Total videos found: 474

â¬‡ï¸  Downloading 1/474: Emotional Mastery-1.mp4
ğŸ†” Video ID: vimRsLwx8pzlV2T5xrZT4Ka
ğŸ“ Filename: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4
âœ… Downloaded: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.mp4
```

### 2. VTT Generation Phase
```bash
$ node vttGenerator.js
ğŸ¬ Processing: Emotional_Mastery-1
ğŸ†” Video ID: vimRsLwx8pzlV2T5xrZT4Ka
ğŸµ Extracting audio...
ğŸ” Analyzing audio for silence and music detection...
ğŸ¤ Using local Whisper for transcription...
ğŸ“ Generating VTT content...
âœ… VTT generated: [vimRsLwx8pzlV2T5xrZT4Ka]_Emotional_Mastery-1.vtt
ğŸ’¡ Ready for caption upload to video ID: vimRsLwx8pzlV2T5xrZT4Ka
```

### 3. Caption Upload Phase
```bash
$ node captionUploader.js
ğŸ“Š Caption Upload Overview:
ğŸ¬ Total VTT files: 474
ğŸ†” Files with video IDs: 474
ğŸ“¤ Uploading caption for video vimRsLwx8pzlV2T5xrZT4Ka...
âœ… Caption uploaded successfully for video vimRsLwx8pzlV2T5xrZT4Ka
ğŸ“Š Caption Upload Summary:
âœ… Successful uploads: 474
```

## Requirements

- **Node.js** 14+ 
- **FFmpeg** (for audio processing)
- **Local Whisper** (recommended) or **OpenAI API Key** (for transcription)
- **API.video Account** with API key

### Ubuntu Server Installation
See [UBUNTU_SETUP.md](UBUNTU_SETUP.md) for complete Ubuntu server setup instructions.

## Cost Considerations

- **API.video**: Check your plan's download/upload limits
- **Local Whisper**: Free transcription (recommended)
- **OpenAI Whisper**: ~$0.006 per minute of audio transcribed (optional)
- **Storage**: Videos and audio files can be large

## Troubleshooting

### Common Issues

1. **FFmpeg not found**: Install FFmpeg and ensure it's in your PATH
2. **Whisper not found**: Install with `pip install openai-whisper`
3. **Caption upload fails**: Check video ID format and API.video permissions
4. **Missing video IDs**: Re-download videos to get proper filename format

### File Migration
If you have old format files (without video IDs), the downloader will automatically rename them when it encounters matching videos.

## License

ISC

## Support

For issues with:
- **API.video API**: Check [API.video documentation](https://docs.api.video/)
- **Local Whisper**: Check [OpenAI Whisper documentation](https://github.com/openai/whisper)
- **This tool**: Open an issue in this repository 